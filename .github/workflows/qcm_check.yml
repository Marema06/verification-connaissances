name: G√©n√©ration QCM & PDF

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3

      - name: üîß Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: üì¶ Installer les d√©pendances
        run: npm install

      - name: ü§ñ G√©n√©rer QCM & code √† trous & PDF
        run: node src/index.js
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}

      - name: üêõ Debug workspace
        run: ls -lah

      - name: üìÅ V√©rifier et pr√©parer le PDF pour upload
        run: |
          if [ -f exo_etudiant.pdf ]; then
            echo "Le fichier exo_etudiant.pdf existe. Upload en cours..."
            mkdir upload
            cp exo_etudiant.pdf upload/
          else
            echo "Le fichier exo_etudiant.pdf est introuvable."
            exit 1
          fi

      - name: üì§ Upload de l'art√©fact PDF
        uses: actions/upload-artifact@v4
        with:
          name: exo_etudiant
          path: upload/exo_etudiant.pdf

      - name: üìù Cr√©er une Issue de rapport
        uses: actions/github-script@v6
        if: success()
        with:
          script: |
            const fs = require('fs');
            try {
              const pdfExists = fs.existsSync('exo_etudiant.pdf');
              const pdfSize = pdfExists ? (fs.statSync('exo_etudiant.pdf').size / 1024).toFixed(2) + ' Ko' : 'Fichier non trouv√©';

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Rapport] QCM g√©n√©r√© - ${new Date().toLocaleDateString('fr-FR')}`,
                body: `Bonjour Professeur,

Un nouveau QCM a √©t√© g√©n√©r√© avec succ√®s :

‚Ä¢ Date: ${new Date().toLocaleString('fr-FR')}
‚Ä¢ Taille PDF: ${pdfSize}
‚Ä¢ Lien: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

  Cordialement,
  Votre assistant QCM`,
labels: ['rapport', 'qcm']
});
  } catch (error) {
core.error('Erreur cr√©ation issue: ' + error);
}
