name: Test QCM API

on: [push, workflow_dispatch]

jobs:
  test-qcm-api:
    runs-on: ubuntu-22.04

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      # ✅ Setup Python en forçant la bonne version
      - name: 🐍 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"  # Guillemets pour éviter les interprétations numériques
          check-latest: true  # Ignore le cache si corrompu

      - name: 🐍 Check Python version
        run: python --version

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          pip install pipdeptree

      - name: 🔐 Create .env file
        run: |
          echo "API_SECRET_TOKEN=${{ secrets.API_SECRET_TOKEN }}" >> .env
          echo "STUDENT_EMAIL=${{ secrets.STUDENT_EMAIL }}" >> .env
          echo "PROF_EMAIL=${{ secrets.PROF_EMAIL }}" >> .env

      - name: 🚀 Start Flask app
        run: |
          nohup python backend/app.py > flask.log 2>&1 &
          sleep 6

      - name: 🌍 Install ngrok
        run: |
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          sudo mv ngrok /usr/local/bin

      - name: 🔑 Auth ngrok
        run: |
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: 🌐 Start ngrok and expose port 5000
        run: |
          nohup ngrok http 5000 > ngrok.log 2>&1 &
          sleep 6

      - name: 📡 Get public ngrok URL
        id: ngrok
        run: |
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "NGROK_URL=$NGROK_URL"
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV

      - name: 🧪 Test the endpoint
        run: |
          curl -X POST "$NGROK_URL/generate_qcm" \
            -H "Authorization: Bearer ${{ secrets.API_SECRET_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"code_block": "print(\"Hello, world!\")"}'

      - name: 📄 Display Flask and ngrok logs
        run: |
          echo "---- Flask Logs ----"
          cat flask.log || echo "flask.log not found"
          echo "---- ngrok Logs ----"
          cat ngrok.log || echo "ngrok.log not found"
