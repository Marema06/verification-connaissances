name: GÃ©nÃ©ration QCM & PDF

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "16"

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: npm install

      - name: ğŸ¤– GÃ©nÃ©rer QCM & PDF
        run: node src/index.js
        env:
          HF_API_KEY: ${{secrets.HF_API_KEY}}

      - name: ğŸ› Debug workspace
        run: ls -lah

      - name: ğŸ“ PrÃ©parer l'artefact PDF
        run: |
          mkdir -p upload
          [ -f exo_etudiant.pdf ] && cp exo_etudiant.pdf upload/ || exit 1

      - name: ğŸ“¤ Upload PDF
        uses: actions/upload-artifact@v4
        with:
          name: qcm-pdf
          path: upload/exo_etudiant.pdf

      - name: ğŸ“ CrÃ©ation Issue Rapport
        if: success()
        uses: actions/github-script@v6
        env:
          PDF_SIZE: ${{ steps.prepare-pdf.outputs.size }}
        with:
          script: |
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Rapport] QCM GÃ©nÃ©rÃ© - ${new Date().toISOString().split('T')[0]}`,
                body: `## Rapport de GÃ©nÃ©ration QCM\n\n` +
                      `âœ… GÃ©nÃ©ration terminÃ©e avec succÃ¨s\n` +
                      `ğŸ“… Date: ${new Date().toLocaleString('fr-FR')}\n` +
                      `ğŸ“„ Fichier: [exo_etudiant.pdf](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n` +
                      `Merci de vÃ©rifier le contenu.`,
                labels: ['rapport', 'qcm']
              });
            } catch (error) {
              core.setFailed('Erreur crÃ©ation issue: ' + error.message);
            }
